\newpage
\section{Determining the most valuable customers}
In e-commerce, the customer lifetime value (CLV) is the value a customer contributes to your business over their lifetime at your company. For example, we could say that customers who purchase many products from Category C are valuable, as products from this category have a high profit margin. Similarly, we could say that customers that leave high ratings on our products are valuable, as they are more likely to recommend our products through word of mouth. \\

\noindent
For simplicity, all customers will be ranked according to the following criteria:
\begin{enumerate}[label=(\arabic*)]
  \item average product value per order in category C
  \item the average rating left on orders
\end{enumerate}

\noindent
Moreover, we wish to design our ranking system in such a way that customers ranked top according to one criterion are still likely to be on top in the ranking with both criteria. That is, the two given criteria are of equal importance and should be weighted equally. For example, a customer with a high average product value per order in Category C that leaves a low average rating on orders should still be towards the top in our ranking system.

\subsection{Calculating the average order value and rating}
In order to get the average product value per order in Category C by a customer, we start by filtering for orders with product category C, then use \lstinline|groupsummary()| to group records by customer ID and take the mean of the product values. The implementation is as follows.

\begin{lstlisting}
OrdersFromC = Orders(strcmp(Orders.Product_Category, 'C') ...
                     & strcmp(Orders.Return, 'N'), :);
CatCValue = groupsummary(OrdersFromC, {'Customer_ID'}, 'mean', 'Product_Value');
\end{lstlisting}

\noindent
Similarly, we can get the average rating for each customer by using the \lstinline|groupsummary()| method on the subset of orders which have a rating. Given that the a rating of 0 implies that a particular product was not rated by the customer, we can get the subset of orders which have a rating by simply checking whether the rating is non-zero. Further, this check will also filter out any orders which have a \lstinline|NaN| rating, and so we have also dealt with case when the data set contains missing data.

\begin{lstlisting}
OrdersWithRatings = Orders(Orders.Rating > 0, :);
Ratings = groupsummary(OrdersWithRatings, {'Customer_ID'}, 'mean', 'Rating');
\end{lstlisting}

\newpage
\subsection{Creating a customer table using outer join}

% TODO: Description of why we wish to create such customer table.

\diagram{outer-join}

\begin{lstlisting}
TLeft = table(CatCValue.Customer_ID, CatCValue.mean_Product_Value, ...
              'VariableNames', {'Customer_ID', 'Mean_Value'});
TRight = table(Ratings.Customer_ID, Ratings.mean_Rating, ...
               'VariableNames', {'Customer_ID', 'Mean_Rating'});
T = outerjoin(TLeft, TRight, 'MergeKeys', true);
\end{lstlisting}

\noindent
Observe that customers that have either not placed any orders for products in category C or not left any ratings on orders, but not both, will have a \lstinline|NaN| value in the table \lstinline|T|. Further, any customer who has never placed an order for a product in category C and has never left a rating on a order will not appear in \lstinline|T|. However, that is the expected behaviour, as we cannot rank customers who have no orders that satisfy the ranking criteria. We will replace any potential \lstinline|NaN| values with 0 using the \lstinline|fillmissing()| function.

\begin{lstlisting}
T = fillmissing(T, 'constant', 0);
\end{lstlisting}

\noindent
All that remains is to derive a ranking based on the values \lstinline|Mean_Value| and \lstinline|Mean_Rating|. \\

\subsection{How do we rank the customers?}
Observe that we have constructed a table \lstinline|T| whose rows consists of customer IDs along with their average order value for products in category C and the average rating they left across all orders. The first few rows of the table \lstinline|T| are as follows.

\begin{lstlisting}
                Customer_ID      Mean_Value        Mean_Rating   
                ___________    ______________    _______________
                  1010269              47.575      4.77777777778
                  1010289               25.74      4.83333333333
                  1010302               18.44      4.71428571429
                  1010314               40.72                4.8
                  1010320        33.566666667                4.8  
\end{lstlisting}

\noindent
We can gain insights regarding the range of the data in our table by calling \lstinline|summary(T)|.

\begin{lstlisting}
      Mean_Value: 913x1 double              Mean_Rating: 913x1 double            
        Values:                               Values:            
          Min                0                  Min       2.444444444                
          Median          31.7                  Median    4.363636363                
          Max             82.3                  Max                 5    
\end{lstlisting}

\noindent
Observe that the range of values for the average order value is much higher than the range of values for the average rating. If we were to take the mean of the two values, the ranking criteria would favour a higher average rating. In order to ensure that the two attributes have equal weighting, we will standardise the data by converting them into standard scores. The standard score is the number of standard deviations by which the value of a data point is above or below the mean value. For example, a customer who leaves an average rating of 4.6 will have a positive standard score, whereas a customer who leaves an average of 4.2 will have a negative standard score, as the mean rating across all orders is 4.3636.

\noindent
A data point $x$ is converted into a standard score $Z$ by

$$Z = \frac{x - \mu}{\sigma}$$

\noindent
where $\mu$ and $\sigma$ are the mean and standard deviation of the population, respectively. In particular, we can make use of the \lstinline|zscore()| function to calculate the standard scores for each of the two columns. Finally, we will calculate a ranking score for each customer by summing the two standard scores.

\begin{lstlisting}
T.Mean_Value = zscore(T.Mean_Value);
T.Mean_Rating = zscore(T.Mean_Rating);
Ranking = table(T.Mean_Value + T.Mean_Rating, 'VariableNames', {'Ranking'});
T = [T Ranking];
\end{lstlisting}

\subsection{Results}

In order to get the most valuable customers, we need to sort the table \lstinline|T| based on the \lstinline|Ranking| column, in descending order. That is, a customer with a higher ranking is a more valuable customer, and perhaps we may wish to reward the most valuable customers with a coupon for their next purchase as a sign of gratitude.

\begin{lstlisting}
T = sortrows(T, 'Ranking', 'Descend');
disp(T(1:10, {'Customer_ID', 'Ranking'}));
\end{lstlisting}

\noindent
The first and last few customers ID's of the top 100 customers are listed below with their respective ranking score.

\begin{lstlisting}
 Rank     Customer_ID     Ranking             Rank     Customer_ID     Ranking  
______    ___________    __________          ______    ___________    __________
   1        1011981       4.296188             91        1015381       1.766911
   2        1012195       3.648415             92        1016337       1.765041
   3        1014288       3.517242             93        1013972       1.746114
   4        1014953       3.388462             94        1015027       1.740111
   5        1016309       3.083884             95        1014365       1.710303
   6        1014622       3.077197             96        1010858       1.708982
   7        1011918       3.042131             97        1012216       1.708916
   8        1010983       3.011226             98        1010467       1.707552
   9        1011559       2.978029             99        1011392       1.696560
  10        1011508       2.930852            100        1012348       1.694950
\end{lstlisting}

% TODO: Are customers that are top in one rank, top in overall rank.
